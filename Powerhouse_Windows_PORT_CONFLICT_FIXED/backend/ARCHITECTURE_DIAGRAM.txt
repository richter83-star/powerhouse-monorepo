╔══════════════════════════════════════════════════════════════════════════════╗
║                 REAL-TIME FEEDBACK PIPELINE ARCHITECTURE                      ║
╚══════════════════════════════════════════════════════════════════════════════╝

┌──────────────────────────────────────────────────────────────────────────────┐
│                          AGENT EXECUTION LAYER                                │
│                                                                                │
│   ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐      │
│   │  ReAct   │  │  Debate  │  │Evaluator │  │Governor  │  │  Memory  │  ... │
│   │  Agent   │  │  Agent   │  │  Agent   │  │  Agent   │  │  Agent   │      │
│   └────┬─────┘  └────┬─────┘  └────┬─────┘  └────┬─────┘  └────┬─────┘      │
│        └─────────────┴──────────────┴─────────────┴─────────────┘            │
└────────────────────────────────────┬─────────────────────────────────────────┘
                                     │
                  ┌──────────────────┴──────────────────┐
                  │   agent.execute(input_data, context) │
                  └──────────────────┬──────────────────┘
                                     ▼
┌──────────────────────────────────────────────────────────────────────────────┐
│                          ACTION DISPATCHER                                    │
│  ┌────────────────────────────────────────────────────────────────────────┐  │
│  │  async dispatch(agent, action_type, input_data, context):              │  │
│  │    1. Start performance timer                                          │  │
│  │    2. Execute pre-hooks                                                │  │
│  │    3. Call agent.execute()                                             │  │
│  │    4. Capture result/errors                                            │  │
│  │    5. Calculate metrics (duration, latency)                            │  │
│  │    6. Create OutcomeEvent                                              │  │
│  │    7. Publish to FeedbackPipeline                                      │  │
│  │    8. Execute post-hooks                                               │  │
│  │    9. Return enriched result                                           │  │
│  └────────────────────────────────────────────────────────────────────────┘  │
│                                                                                │
│  Features:                                                                     │
│    ✓ Automatic metrics collection                                             │
│    ✓ Error capture with stack traces                                          │
│    ✓ Pre/post execution hooks                                                 │
│    ✓ Workflow correlation                                                     │
│    ✓ Tag-based categorization                                                 │
└────────────────────────────────────┬─────────────────────────────────────────┘
                                     │
                                     ▼
                          ┌──────────────────────┐
                          │   OutcomeEvent       │
                          │   ---------------    │
                          │   • event_id         │
                          │   • agent_name       │
                          │   • status           │
                          │   • duration_ms      │
                          │   • latency_ms       │
                          │   • tokens_used      │
                          │   • error_details    │
                          │   • tags             │
                          │   • metadata         │
                          └──────────┬───────────┘
                                     │
                                     ▼
┌──────────────────────────────────────────────────────────────────────────────┐
│                          FEEDBACK PIPELINE                                    │
│  ┌────────────────────────────────────────────────────────────────────────┐  │
│  │  async record_outcome(event):                                          │  │
│  │    1. Add to local buffer (1000 max)                                   │  │
│  │    2. Log event (severity-based)                                       │  │
│  │    3. Publish to Kafka (if enabled)                                    │  │
│  └────────────────────────────────────────────────────────────────────────┘  │
│                                                                                │
│  ┌──────────────┐     ┌─────────────────┐     ┌──────────────────┐          │
│  │ Local Buffer │     │ Logging System  │     │  Kafka Publisher │          │
│  │ (1000 events)│     │ (Fallback)      │     │  (Primary)       │          │
│  └──────┬───────┘     └────────┬────────┘     └────────┬─────────┘          │
│         │                      │                        │                     │
│         ├──────────────────────┼────────────────────────┤                     │
│         │                      │                        │                     │
│  ┌──────▼───────────────────────▼────────────────────────▼─────────────┐     │
│  │  Query Interface: get_recent_events(count, agent, status)           │     │
│  └──────────────────────────────────────────────────────────────────────┘     │
└────────────────────────────────┬─────────────────────────────────────────────┘
                                 │
                  ┌──────────────┼──────────────┐
                  │              │              │
                  ▼              ▼              ▼
        ┌──────────────┐  ┌──────────┐  ┌──────────────┐
        │   Logging    │  │  Buffer  │  │    Kafka     │
        │   (stderr)   │  │ (memory) │  │  (external)  │
        └──────────────┘  └──────────┘  └──────┬───────┘
                                                │
        ┌───────────────────────────────────────┼───────────────────┐
        │                   Kafka Topics                             │
        │  ┌──────────────────┐ ┌────────────┐ ┌─────────────────┐ │
        │  │ agent-outcomes   │ │   agent-   │ │   agent-alerts  │ │
        │  │ (3 partitions)   │ │   metrics  │ │  (1 partition)  │ │
        │  └──────────────────┘ └────────────┘ └─────────────────┘ │
        └────────────────────────────┬──────────────────────────────┘
                                     │
        ┌────────────────────────────┴──────────────────────────────┐
        │                 DOWNSTREAM CONSUMERS                       │
        │  ┌──────────────┐ ┌──────────────┐ ┌──────────────────┐  │
        │  │  Real-Time   │ │   Alerting   │ │   Analytics/DW   │  │
        │  │  Dashboards  │ │   System     │ │   (Historical)   │  │
        │  │  (Grafana)   │ │ (PagerDuty)  │ │  (BigQuery)      │  │
        │  └──────────────┘ └──────────────┘ └──────────────────┘  │
        └───────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────────────────────┐
│                     ORCHESTRATION DISPATCHER                                  │
│  ┌────────────────────────────────────────────────────────────────────────┐  │
│  │  async execute_workflow(agents, task, tags):                           │  │
│  │    workflow_id = uuid()                                                │  │
│  │    for agent in agents:                                                │  │
│  │      result = await dispatcher.dispatch(                               │  │
│  │        agent, "workflow_step", task, context,                          │  │
│  │        workflow_id=workflow_id, tags=tags                              │  │
│  │      )                                                                  │  │
│  │      if result.status == "failure": break                              │  │
│  │    return workflow_results                                             │  │
│  └────────────────────────────────────────────────────────────────────────┘  │
│                                                                                │
│  Features:                                                                     │
│    ✓ Multi-agent coordination                                                 │
│    ✓ Workflow-level correlation (workflow_id)                                 │
│    ✓ Failure handling (stop on error)                                         │
│    ✓ Per-agent outcome tracking                                               │
└──────────────────────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────────────────────┐
│                          DATA FLOW SUMMARY                                    │
│                                                                                │
│  Agent → Dispatcher → OutcomeEvent → Pipeline → [Buffer + Log + Kafka]       │
│                                                                                │
│  Latency Breakdown:                                                            │
│    Agent Execution:     Variable (100-5000ms)                                 │
│    Event Creation:      < 1ms                                                 │
│    Pipeline Recording:  < 5ms (async)                                         │
│    Kafka Publishing:    < 10ms (batched)                                      │
│    Total Overhead:      < 5% of agent execution time                          │
│                                                                                │
│  Event Schema (30+ fields):                                                   │
│    Identification:  event_id, run_id, agent_name, action_type                │
│    Timing:          timestamp, duration_ms, latency_ms                        │
│    Outcome:         status, severity, error_message, error_type              │
│    Performance:     llm_latency_ms, tokens_used, memory_used_mb              │
│    Context:         workflow_id, correlation_id, tags, metadata              │
│                                                                                │
│  Status Types:                                                                │
│    SUCCESS | FAILURE | PARTIAL | TIMEOUT | CANCELLED | PENDING               │
│                                                                                │
│  Severity Levels:                                                             │
│    INFO | WARNING | ERROR | CRITICAL                                          │
└──────────────────────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────────────────────┐
│                        CONFIGURATION OPTIONS                                  │
│                                                                                │
│  Development (No Kafka):                                                      │
│    ENABLE_KAFKA=false                                                         │
│    ENABLE_OUTCOME_LOGGING=true                                                │
│    → Events logged to stderr, buffered in memory                              │
│                                                                                │
│  Production (With Kafka):                                                     │
│    ENABLE_KAFKA=true                                                          │
│    KAFKA_BOOTSTRAP_SERVERS=kafka.prod.com:9092                                │
│    KAFKA_OUTCOME_TOPIC=agent-outcomes                                         │
│    KAFKA_BATCH_SIZE=100                                                       │
│    KAFKA_COMPRESSION=gzip                                                     │
│    → Events published to Kafka for real-time processing                       │
└──────────────────────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────────────────────┐
│                          USE CASES                                            │
│                                                                                │
│  1. Performance Monitoring:                                                   │
│     • Track average latency per agent type                                    │
│     • Identify slow agents (> threshold)                                      │
│     • Monitor LLM token usage and costs                                       │
│                                                                                │
│  2. Error Detection & Debugging:                                              │
│     • Real-time alerts on failures                                            │
│     • Stack traces for debugging                                              │
│     • Correlation IDs for request tracing                                     │
│                                                                                │
│  3. Quality Assurance:                                                        │
│     • Track success rates by agent                                            │
│     • Monitor confidence scores                                               │
│     • Identify error patterns                                                 │
│                                                                                │
│  4. Business Intelligence:                                                    │
│     • Workflow completion times                                               │
│     • Cost attribution (tokens, API calls)                                    │
│     • Usage analytics (by client, workflow)                                   │
│                                                                                │
│  5. Adaptive Learning:                                                        │
│     • Feedback for model fine-tuning                                          │
│     • Performance trends over time                                            │
│     • A/B testing metrics                                                     │
└──────────────────────────────────────────────────────────────────────────────┘

╔══════════════════════════════════════════════════════════════════════════════╗
║  KEY BENEFITS:                                                                ║
║    ✓ Complete observability into agent operations                            ║
║    ✓ Real-time performance monitoring                                        ║
║    ✓ Comprehensive error tracking                                            ║
║    ✓ Production-ready with Kafka integration                                 ║
║    ✓ Low overhead (< 5% impact on execution)                                 ║
║    ✓ Fully tested (14 unit tests passing)                                    ║
║    ✓ Extensive documentation (3 comprehensive docs)                          ║
╚══════════════════════════════════════════════════════════════════════════════╝
